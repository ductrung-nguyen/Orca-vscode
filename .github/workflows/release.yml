# Semantic Release Workflow for VS-ORCA Extension
# Automatically triggers on push to main branch
# Uses semantic-release to:
# 1. Analyze commit messages (conventional commits)
# 2. Determine next version
# 3. Generate CHANGELOG
# 4. Publish to VS Code Marketplace
# 5. Create GitHub Release with .vsix artifact
# 6. Update package.json and commit changes
#
# Prerequisites:
# - VSCE_PAT secret must be configured in repository settings
# - PAT must have Marketplace > Manage scope
# - GH_TOKEN or GITHUB_TOKEN for GitHub releases

name: Release

on:
  push:
    branches:
      - main

# Ensure only one release runs at a time
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write  # Required for creating releases and pushing commits
      issues: write    # Required for commenting on issues
      pull-requests: write  # Required for commenting on PRs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for semantic-release to analyze all commits

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Run linting
        run: npm run lint

      - name: Run tests with Xvfb
        run: xvfb-run -a npm test
        env:
          DISPLAY: ':99.0'

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx semantic-release

      - name: Summary
        if: success()
        run: |
          {
            echo "âœ… Release workflow completed successfully!"
            echo "Check the releases page for the new version."
            echo "### Changelog"
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details."
          } >> "$GITHUB_STEP_SUMMARY"
